---
title: "Data analysis"
output: pdf_document
---
```{r}
library(vegan)
library(betapart)
library(grid)
library(ggplot2)
```
NDMS with variable surfing
```{r}

getwd()
species = read.csv("input_data.csv")
#-----------------------------------------------------alternative
species<-read.table("clipboard", header=T, sep="\t")
enviro<-read.table("clipboard", header=T, sep="\t")

species <- species[-c(86), ] ; enviro <- enviro[-c(86), ]

species_NMDS <- species[,6:638] ; rownames(species_NMDS) <- paste(species$river, species$sampleID,sep=" ")
enviro_NMDS <- enviro[,6:15] ; rownames(enviro_NMDS) <- paste(enviro$river, enviro$sampleID,sep=" ")

example_NMDS=metaMDS(species_NMDS) #k=2dimesnions amnd trymax=max number of random starts in                                                        search of stable solution (makes the iterations a bit                                                            longer)
example_NMDS

scrs <- as.data.frame(scores(example_NMDS, display = "sites"))
vf <- envfit(example_NMDS, enviro_NMDS, perm = 999,na.rm=T)
#fit environemntal variables to NMDS ('envfit' works the other direction to RDA, 
#how ordination explains enviro variation; run RDA if you want to compare
#geo vs. enviro or how well enviro predicts species)

spp.scrs <- as.data.frame(scores(vf, display = "vectors"))
spp.scrs <- cbind(spp.scrs, Species = rownames(spp.scrs))

ggplot(scrs) +
  geom_point(mapping = aes(x = NMDS1, y = NMDS2, colour = species$river)) +
  coord_fixed() + ## need aspect ratio of 1!
  geom_segment(data = spp.scrs,
               aes(x = 0, xend = NMDS1, y = 0, yend = NMDS2),
               arrow = arrow(length = unit(0.25, "cm")), colour = "grey") +
  geom_text(data = spp.scrs, aes(x = NMDS1, y = NMDS2, label = Species),
            size = 3)

#basic plots for NMDS
ordisurf(example_NMDS,species$tn,main="",col="forestgreen")
orditorp(example_NMDS,display="sites",col="grey30",air=0.1,cex=1)


#inference
anosim(species_NMDS, species$zone, permutations=999)
stressplot(example_NMDS)

```

Alpha and beta diversity
```{r}
#Diversity metrics--------------------------------------------------------------------------------------
library(vegan)
library(betapart)
#shanon diversity
spec <- species[,6:760]
shannon<-diversity(spec, index = "shannon")
shannon<-as.vector(shannon)
shannon<-as.data.frame(shannon)

plot(shannon)
diversity<-cbind(shannon,species[,1:6])
plot(diversity$river,diversity$shannon)
plot(results$river,results$var,ylim=c(0,4000))
write.csv(diversity,file = "C:/Users/admin/Dropbox/b.mscripts/biofilmMARC/Datasets/working datasets/diversity.csv")

#for betadiversity
presabs<-ifelse(spec>0,1,0)
dist<-beta.pair(presabs, index.family="sorensen")
# To get the pairwise Jaccard index turnover partition between communities, type: dist[[1]]. 
#To get nestedness partition, type: dist[[2]]. To get all beta diversity: dist[[3]].
dist[[2]]
# If we want to compare the beta diversities of communities aggregated by groups
#we can use "betadisper" analysis.
#<<<<<<< HEAD
groups <- factor(species$river)
#=======
groups <- factor(species$region)
#>>>>>>> 9c5ec016de380e06e2262db9fac802b1163a7057
bd<-betadisper(dist[[3]],groups)
plot(bd)
boxplot(bd)
anova(bd)
```

```{r}
# Using bray-curtis dissimilarity and thus abundance data as well
#The function will calculate beta diversity (and its partitions) based on Bray-Curtis dissimilarity index.
spec<-read.table("clipboard",header=T,sep="\t")
presabs<-ifelse(spec>0,1,0)
dist<-beta.pair(presabs, index.family="sorensen")
turnover<-as.data.frame(as.vector(dist[[1]]))
nestedness<-as.data.frame(as.vector(dist[[2]]))
beta<-as.data.frame(as.vector(dist[[3]]))
beta<-cbind(turnover,nestedness,beta)
write.csv(beta,file = "C:/Users/admin/Dropbox/b.mscripts/biofilmMARC/Datasets/working datasets/beta.csv")

#try beta.div() to get SCBD and LCBD


```

